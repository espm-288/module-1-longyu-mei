---
title: "Module 1: Tabular Data"
subtitle: "Working with larger-than-RAM data using duckdbfs"
author: "ESPM 288"
format: 
  html:
    theme: cosmo
    toc: true
    toc-location: left
    toc-depth: 3
    code-fold: false
    code-tools: true
    code-line-numbers: true
    embed-resources: true
    page-layout: full
    self-contained: true
---

Explain our analysis and so forth.

## Setup

```{r}
library(duckdbfs)
library(dplyr)
library(ggplot2)
```
## Exercise 1: connecting to remote data

We can open the entire dataset without downloading it using `open_dataset()`. The data is hosted on Source Cooperative. The `**` pattern allows recursive scanning of the partitioned parquet files.

```{r}
# Remote S3 path to EXIOBASE 3 (Source Cooperative)

duckdbfs::duckdb_secrets(
    key = "",
    secret = "",
    endpoint = "s3.amazonaws.com",
    region = "us-west-2"
)
s3_url <- "s3://us-west-2.opendata.source.coop/youssef-harby/exiobase-3/4588235/parquet/**"

# Open the dataset lazily
exio <- open_dataset(s3_url)

# View the schema (column names and types) without reading data
glimpse(exio)
```

I want to identify data on the CO2 production country by country over time.

First let's see what tables are available in the dataset:

```{r}
exio|>
    distinct(matrix) |>
    collect()
```

Open the F_satellite table only in the data, and give me unique values for the stressor column:
```{r}
exio|>
    filter(matrix == "F_satellite") |>
    distinct(stressor) |>
    collect()

```

There's a lot of possible stressor types, how can I find the ones that are just about CO2(carbon dioxide emissions)?

```{r}
exio|>
    filter(matrix == "F_satellite",
           stressor %like% "%CO2%") |>
    filter(grepl("CO2|carbon dioxide", stressor, ignore.case = TRUE)) |>
    distinct(stressor) |>
    collect()
```

Identify which regions are the top 5 CO2 emitters:
```{r}
# Get top 5 CO2 emitting regions across all years
top_co2_regions <- exio |>
    filter(matrix == "F_satellite",
           stressor %like% "%CO2%") |>
    group_by(region) |>
    summarise(total_co2 = sum(value, na.rm = TRUE),
              unit = first(unit)) |>
    arrange(desc(total_co2)) |>
    head(5) |>
    collect()

top_co2_regions
```

Filter the co2 data down to just the top 5 emitting regions, and plot the trend over time, and export:
```{r}
# Extract the top 5 region names
top5_regions <- top_co2_regions$region

# Get time series data for top 5 emitters
co2_timeseries <- exio |>
    filter(matrix == "F_satellite",
           stressor %like% "%CO2%",
           region %in% top5_regions) |>
    group_by(year, region) |>
    summarise(total_co2 = sum(value, na.rm = TRUE)) |>
    arrange(year, region) |>
    collect()

# Create the plot
plot_regions <- ggplot(co2_timeseries, aes(x = year, y = total_co2, color = region, group = region)) +
    geom_line(linewidth = 1.2) +
    geom_point(size = 2) +
    labs(title = "CO2 Emissions Over Time: Top 5 Emitters",
         x = "Year",
         y = "Total CO2 Emissions",
         color = "Region") +
    theme_minimal() +
    theme(legend.position = "bottom",
          plot.title = element_text(hjust = 0.5, face = "bold"))

# Save the plot
ggsave("co2_emissions_regions.png", plot = plot_regions, width = 10, height = 6, dpi = 300)

# Display the plot
plot_regions
```

Export all unique stressor types from F_matrix to a markdown file:
```{r}
# Get all unique stressor types from F_satellite
stressors <- exio |>
    filter(matrix == "F_satellite") |>
    distinct(stressor) |>
    collect()

# Write to markdown file
writeLines(
    c("# F_satellite Stressor Types",
      "",
      paste("Total unique stressors:", nrow(stressors)),
      "",
      "## List of Stressors",
      "",
      paste("-", stressors$stressor)),
    "stressor_types.md"
)

cat("Exported", nrow(stressors), "stressor types to stressor_types.md\n")
```

Just like what we did for CO2 emissions by region, I want to see the ones by sector. Please give me the top 5 sectors and plot them over time as well.

Identify which sectors are the top 5 CO2 emitters:
```{r}
# Get top 5 CO2 emitting sectors across all years
top_co2_sectors <- exio |>
    filter(matrix == "F_satellite",
           stressor %like% "%CO2%") |>
    group_by(sector) |>
    summarise(total_co2 = sum(value, na.rm = TRUE),
              unit = first(unit)) |>
    arrange(desc(total_co2)) |>
    head(5) |>
    collect()

top_co2_sectors
```

Filter the CO2 data down to just the top 5 emitting sectors, and plot the trend over time:
```{r}
# Extract the top 5 sector names
top5_sectors <- top_co2_sectors |>
    pull(sector)

# Get time series data for top 5 sectors
co2_timeseries_sectors <- exio |>
    filter(matrix == "F_satellite",
           stressor %like% "%CO2%",
           sector %in% top5_sectors) |>
    group_by(year, sector) |>
    summarise(total_co2 = sum(value, na.rm = TRUE)) |>
    arrange(year, sector) |>
    collect()

# Create the plot
plot_sectors <- ggplot(co2_timeseries_sectors, aes(x = year, y = total_co2, color = sector, group = sector)) +
    geom_line(linewidth = 1.2) +
    geom_point(size = 2) +
    labs(title = "CO2 Emissions Over Time: Top 5 Sectors",
         x = "Year",
         y = "Total CO2 Emissions",
         color = "Sector") +
    theme_minimal() +
    theme(legend.position = "bottom",
          plot.title = element_text(hjust = 0.5, face = "bold"))

# Save the plot
ggsave("co2_emissions_sectors.png", plot = plot_sectors, width = 10, height = 6, dpi = 300)

# Display the plot
plot_sectors
```